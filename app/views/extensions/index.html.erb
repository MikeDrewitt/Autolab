<% @title = "Manage Extensions" %>

<% content_for :stylesheets do %>
  <%= stylesheet_link_tag 'chosen.min' %>
<% end %>

<% content_for :javascripts do %>
  <%= javascript_include_tag 'chosen.jquery.min' %>
  <%= javascript_include_tag "initialize_datetimepickers" %>
  
  <script type="application/javascript">
    jQuery(function() {
      $dueDate = moment("<%= @assessment.due_at.to_s %>", "YYYY-MM-DD hh:mm:ss ZZ");

      $extensionDaysField = $('#extension_days');
      $extensionNewDayField = $('#extension_due_at');
      $extensionDaysLabel = $('label[for="extension_days"]');

      $('.chosen-select').chosen({width: '100%'});

      /* Enable/disable extension days options */
      $enableInfiniteExtension = $('#extension_infinite');
      if ($enableInfiniteExtension.is(':checked')) {
        $extensionDaysField.prop('disabled',true);
        $extensionNewDayField.prop('disabled',true);
      }
      $enableInfiniteExtension.click(function() {
        if ($enableInfiniteExtension.is(':checked')) {
          $extensionDaysField.prop('disabled',true);
          $extensionNewDayField.prop('disabled',true);
        } else {
          $extensionDaysField.prop('disabled',false);
          $extensionNewDayField.prop('disabled',false);
        }
      });

      /* set initial value to original due date */
      $extensionNewDayField.flatpickr({enableTime: true}).setDate($dueDate.toDate());
    });
  </script>

<% end %>

<% if params[:errors] then %>
  <br><i>Errors:<%= params[:errors] %></i><br>
  <p></p>
<% end %>

<p> Current Due: <span class="moment-date-time"><%= @assessment.due_at.to_s %></span> </p>

<div class="row">
  <div class="col s12 m6">
    <p><b>Current Extensions</b></p>
    Size:<%= @extensions.size %>
    <table class="verticalTable">
      <thead>
        <tr>
          <th>Email/Section</th>
          <th colspan=2>New Due Date</th>
        </tr>
      </thead>

      <tbody>
        <% for ext in @extensions do %>
        <% convertedTime = DateTime.strptime(ext.due_at.to_s,'%s') %>
        <% newDate =  convertedTime.strftime("%B #{convertedTime.day.ordinalize} %Y, %-l:%M %P") %>
          <tr>
            <th><%= ext.course_user_datum.nil? ? ext.assessment.course.sections.find(ext.section_id).name : ext.course_user_datum.email %></th>
            <td style="padding: 0 5px"><%= ext.infinite? ? "Infinite" : "#{newDate}" %></td>
            <td><%= link_to '<i class="material-icons">delete</i>'.html_safe, [@course, @assessment, ext], method: :delete %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="col s12 m6">
    <p><b>Create New Extension</b></p>
      <p> Select A User </p>
      <%= form_for @new_extension, :as=>"extension", :url=>{:action=>"create"}, builder: FormBuilderWithDateTimeInput do |f| %>
        <% if @new_extension.errors.any? %>
          <div>
            <ul>
              <% @new_extension.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>
        <%= f.select(:course_user_datum_id, @users.sort, {prompt: 'select user'}, {class: ''}) %>
        <p>-OR- Select A Section</p>
        <%= f.collection_select(:section_id, @course.sections, :id, :name, prompt: 'select section') %>
        <p>Select a new due date</p>
        <%= f.datetime_select :due_at , id: "extension_due_at" %><br>
        <p>-OR- Infinite Extension? <%= f.check_box :infinite, id: "extension_infinite" %></p>
        <%= f.hidden_field(:assessment_id)%>
        <%= f.submit "Create" , {:class=>"btn primary"} %>
      <% end %>
  </div>

</div>
